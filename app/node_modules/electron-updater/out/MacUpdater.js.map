{"version":3,"file":"MacUpdater.js","sourceRoot":"","sources":["../src/MacUpdater.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { CancellationToken, configureRequestOptionsFromUrl, DigestTransform, ProgressCallbackTransform, AllPublishOptions, RequestHeaders, safeGetHeader, VersionInfo } from \"builder-util-runtime\"\nimport { createServer, IncomingMessage, OutgoingHttpHeaders, ServerResponse } from \"http\"\nimport { AppUpdater } from \"./AppUpdater\"\nimport { DOWNLOAD_PROGRESS, FileInfo, UPDATE_DOWNLOADED } from \"./main\"\nimport AutoUpdater = Electron.AutoUpdater\n\nexport class MacUpdater extends AppUpdater {\n  private readonly nativeUpdater: AutoUpdater = require(\"electron\").autoUpdater\n\n  constructor(options?: AllPublishOptions) {\n    super(options)\n\n    this.nativeUpdater.on(\"error\", it => {\n      this._logger.warn(it)\n      this.emit(\"error\", it)\n    })\n    this.nativeUpdater.on(\"update-downloaded\", () => {\n      this._logger.info(`New version ${this.versionInfo!.version} has been downloaded`)\n      this.emit(UPDATE_DOWNLOADED, this.versionInfo)\n    })\n  }\n\n  protected doDownloadUpdate(versionInfo: VersionInfo, fileInfo: FileInfo, cancellationToken: CancellationToken): Promise<Array<string>> {\n    const server = createServer()\n    server.on(\"close\", () => {\n      this._logger.info(`Proxy server for native Squirrel.Mac is closed (was started to download ${fileInfo.url})`)\n    })\n\n    function getServerUrl() {\n      const address = server.address()\n      return `http://${address.address}:${address.port}`\n    }\n\n    return new BluebirdPromise<Array<string>>((resolve, reject) => {\n      server.on(\"request\", (request: IncomingMessage, response: ServerResponse) => {\n        const requestUrl = request.url!\n        this._logger.info(`${requestUrl} requested`)\n        if (requestUrl === \"/\") {\n          const data = Buffer.from(`{ \"url\": \"${getServerUrl()}/app.zip\" }`)\n          response.writeHead(200, {\"Content-Type\": \"application/json\", \"Content-Length\": data.length})\n          response.end(data)\n        }\n        else if (requestUrl.startsWith(\"/app.zip\")) {\n          let errorOccurred = false\n          response.on(\"finish\", () => {\n            try {\n              setImmediate(() => server.close())\n            }\n            finally {\n              if (!errorOccurred) {\n                this.nativeUpdater.removeListener(\"error\", reject)\n                resolve([])\n              }\n            }\n          })\n          this.proxyUpdateFile(response, fileInfo, cancellationToken, error => {\n            errorOccurred = true\n            try {\n              response.writeHead(500)\n              response.end()\n            }\n            finally {\n              this.nativeUpdater.removeListener(\"error\", reject)\n              reject(new Error(`Cannot download \"${fileInfo.url}\": ${error}`))\n            }\n          })\n        }\n        else {\n          this._logger.warn(`${requestUrl} requested, but not supported`)\n          response.writeHead(404)\n          response.end()\n        }\n      })\n      server.listen(0, \"127.0.0.1\", 16, () => {\n        this.nativeUpdater.setFeedURL(`${getServerUrl()}`, {\"Cache-Control\": \"no-cache\"})\n\n        this.nativeUpdater.once(\"error\", reject)\n        this.nativeUpdater.checkForUpdates()\n      })\n    })\n  }\n\n  private proxyUpdateFile(nativeResponse: ServerResponse, fileInfo: FileInfo, cancellationToken: CancellationToken, errorHandler: (error: Error) => void) {\n    this.doProxyUpdateFile(nativeResponse, fileInfo.url, this.computeRequestHeaders(fileInfo), fileInfo.sha512 || null, cancellationToken, errorHandler)\n  }\n\n  private doProxyUpdateFile(nativeResponse: ServerResponse, url: string, headers: OutgoingHttpHeaders, sha512: string | null, cancellationToken: CancellationToken, errorHandler: (error: Error) => void) {\n    const downloadRequest = this.httpExecutor.doRequest(configureRequestOptionsFromUrl(url, {headers}), downloadResponse => {\n      if (downloadResponse.statusCode! >= 400) {\n        try {\n          nativeResponse.writeHead(404)\n          nativeResponse.end()\n        }\n        finally {\n          errorHandler(new Error(`Cannot download \"${url}\", status ${downloadResponse.statusCode}: ${downloadResponse.statusMessage}`))\n        }\n        return\n      }\n\n      // in tests Electron NET Api is not used, so, we have to handle redirect.\n      const redirectUrl = safeGetHeader(downloadResponse, \"location\")\n      if (redirectUrl != null) {\n        this.doProxyUpdateFile(nativeResponse, redirectUrl, headers, sha512, cancellationToken, errorHandler)\n        return\n      }\n\n      const nativeHeaders: RequestHeaders = {\"Content-Type\": \"application/zip\"}\n      const streams: Array<any> = []\n      const downloadListenerCount = this.listenerCount(DOWNLOAD_PROGRESS)\n      this._logger.info(`${DOWNLOAD_PROGRESS} listener count: ${downloadListenerCount}`)\n      if (downloadListenerCount > 0) {\n        const contentLength = safeGetHeader(downloadResponse, \"content-length\")\n        this._logger.info(`contentLength: ${contentLength}`)\n        if (contentLength != null) {\n          nativeHeaders[\"Content-Length\"] = contentLength\n          streams.push(new ProgressCallbackTransform(parseInt(contentLength, 10), cancellationToken, it => this.emit(DOWNLOAD_PROGRESS, it)))\n        }\n      }\n\n      nativeResponse.writeHead(200, nativeHeaders)\n\n      // for mac only sha512 is produced (sha256 is published for windows only to preserve backward compatibility)\n      if (sha512 != null) {\n        // \"hex\" to easy migrate to new base64 encoded hash (we already produces latest-mac.yml with hex encoded hash)\n        streams.push(new DigestTransform(sha512, \"sha512\", sha512.length === 128 && !sha512.includes(\"+\") && !sha512.includes(\"Z\") && !sha512.includes(\"=\") ? \"hex\" : \"base64\"))\n      }\n\n      streams.push(nativeResponse)\n\n      let lastStream = downloadResponse\n      for (const stream of streams) {\n        stream.on(\"error\", errorHandler)\n        lastStream = lastStream.pipe(stream)\n      }\n    })\n\n    downloadRequest.on(\"error\", errorHandler)\n    downloadRequest.end()\n  }\n\n  quitAndInstall(): void {\n    this.nativeUpdater.quitAndInstall()\n  }\n}"]}
